# ğŸ¯ RESUMEN RÃPIDO: Cambios de Columnas

## ğŸ“Š Mapeo Visual: Viejo â†’ Nuevo

```
VIEJO                           NUEVO (Columnas Mejoradas)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ID SUBASTA        â”€â”€â”€â”€â”€â”€â”€â†’      ID SUBASTA        âœ… Sin cambio
ITEM              â”€â”€â”€â”€â”€â”€â”€â†’      ITEM              âœ… Sin cambio
DESCRIPCION       â”€â”€â”€â”€â”€â”€â”€â†’      DESCRIPCION       âœ… Sin cambio
QUANTITY          â”€â”€â”€â”€â”€â”€â”€â†’      CANTIDAD          âœ… Mismo en Excel
UNIDAD DE MEDIDA  â”€â”€â”€â”€â”€â”€â”€â†’      UNIDAD DE MEDIDA  âœ… Sin cambio
MARCA             â”€â”€â”€â”€â”€â”€â”€â†’      MARCA             âœ… Sin cambio
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Observaciones     â”€â”€â”€â”€â”€â”€â”€â†’      OBS USUARIO       ğŸ“ Renombrado
CONVERSIÃ“N USD    â”€â”€â”€â”€â”€â”€â”€â†’      CONVERSIÃ“N USD    âœ… Sin cambio
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[NEW]                   â”€â”€â”€â†’    COSTO UNIT USD     âœ¨ NUEVA (fÃ³rmula)
[NEW]                   â”€â”€â”€â†’    COSTO TOTAL USD    âœ¨ NUEVA (fÃ³rmula)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COSTO FINAL PESOS (ambiguo) â”€â†’  COSTO UNIT ARS     ğŸ“ Renombrado + Claridad
SUBTOTAL COSTO PESOS    â”€â”€â”€â†’    COSTO TOTAL ARS    ğŸ“ Renombrado + Claridad
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RENTA (multiplicador) â”€â”€â†’        RENTA MINIMA %     ğŸ“ Renombrado + % claro
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[NEW]                   â”€â”€â”€â†’    PRECIO UNIT ACEPTABLE    âœ¨ NUEVA (fÃ³rmula)
[NEW]                   â”€â”€â”€â†’    PRECIO TOTAL ACEPTABLE   âœ¨ NUEVA (fÃ³rmula)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Precio referencia       â”€â”€â”€â†’    PRECIO DE REFERENCIA     âœ… Sin cambio
[NEW]                   â”€â”€â”€â†’    PRECIO REF UNITARIO      âœ¨ NUEVA (fÃ³rmula)
RENTA/ REF              â”€â”€â”€â†’    RENTA REFERENCIA %       ğŸ“ Renombrado + %
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MEJOR OFERTA            â”€â”€â”€â†’    MEJOR OFERTA ACTUAL      ğŸ“ MÃ¡s claro
OFERTA PARA MEJORAR     â”€â”€â”€â†’    OFERTA PARA MEJORAR      âœ… Sin cambio
P. UNIT MEJORA          â”€â”€â”€â†’    PRECIO UNIT MEJORA       ğŸ“ Nombre completo
[NEW]                   â”€â”€â”€â†’    RENTA PARA MEJORAR %     âœ¨ NUEVA (fÃ³rmula)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Obs / Cambio            â”€â”€â”€â†’    OBS / CAMBIO             âœ… Sin cambio
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[REMOVED]               â”€â”€â”€â†’    [No mostrar]
dif unit                        (se calcula on-the-fly)   
Renta DPC                       â†’ RENTA PARA MEJORAR %
P.UNIT MINIMO                   â†’ PRECIO UNIT ACEPTABLE
SUBTOTAL                        â†’ (cÃ¡lculo interno)
```

---

## ğŸ”‘ Cambios Clave

### 1ï¸âƒ£ **Claridad en Costos ARS**

| Concepto | Viejo | Nuevo | Por quÃ© |
|----------|-------|-------|---------|
| Costo por unidad | `costo_final` | `COSTO UNIT ARS` | Ambiguo si es total o unitario |
| Costo total | `subtotal_costo` | `COSTO TOTAL ARS` | Muy genÃ©rico |

### 2ï¸âƒ£ **Conversion a USD (Nuevas columnas)**

```
Usuario ingresa:
  CONVERSIÃ“N USD = 1000 (pesos por dÃ³lar)
  COSTO UNIT ARS = 500.000

Sistema calcula:
  COSTO UNIT USD = 500.000 / 1000 = 500 USD
  COSTO TOTAL USD = COSTO TOTAL ARS / CONVERSIÃ“N USD
```

### 3ï¸âƒ£ **Rentabilidad MÃ­nima (Mejora importante)**

**Viejo:** Usuario ingresa `RENTA = 1.3` (confuso: Â¿1.3x o 30%?)

**Nuevo:** Usuario ingresa `RENTA MINIMA % = 30` (usuario dice: "quiero 30% de utilidad")

Sistema calcula:
- `PRECIO UNIT ACEPTABLE = COSTO UNIT ARS * 1.30` (costo + 30%)
- `PRECIO TOTAL ACEPTABLE = COSTO TOTAL ARS * 1.30`

### 4ï¸âƒ£ **AnÃ¡lisis de Referencia (Nuevas columnas)**

```
Cuando Playwright trae PRECIO DE REFERENCIA de la subasta:

Sistema calcula:
  PRECIO REF UNITARIO = PRECIO DE REFERENCIA / CANTIDAD
  RENTA REFERENCIA % = (PRECIO REF UNITARIO / COSTO TOTAL ARS) - 1
  
Ejemplo:
  PRECIO DE REFERENCIA = 100.000
  CANTIDAD = 10
  COSTO TOTAL ARS = 50.000
  
  â†’ PRECIO REF UNITARIO = 10.000
  â†’ RENTA REFERENCIA % = (10.000 / 50.000) - 1 = 0.20 = 20%
```

### 5ï¸âƒ£ **AnÃ¡lisis de Mejora (Mejor claridad)**

**Viejo confuso:**
```
P. UNIT MEJORA     = ???  (Â¿mejora quÃ© cosa?)
dif unit           = ???  (Â¿diferencia de quÃ©?)
Renta DPC          = ???  (Â¿quÃ© es DPC?)
SUBTOTAL PARA MEJORAR = OFERTA PARA MEJORAR (Â¿por quÃ© dos nombres?)
```

**Nuevo, claro:**
```
PRECIO UNIT MEJORA = OFERTA PARA MEJORAR / CANTIDAD
RENTA PARA MEJORAR % = (PRECIO UNIT MEJORA / COSTO TOTAL ARS) - 1

Ejemplo:
  OFERTA PARA MEJORAR = 11.000
  CANTIDAD = 10
  COSTO TOTAL ARS = 50.000
  
  â†’ PRECIO UNIT MEJORA = 1.100
  â†’ RENTA PARA MEJORAR % = (1.100 / 50.000) - 1 = -0.978 = âŒ PÃ‰RDIDA 97.8%
```

---

## ğŸ”„ **Caso Especial: Bidireccionalidad COSTO**

El usuario puede ingresar:

### OpciÃ³n A: Solo COSTO UNIT ARS
```
Usuario ingresa:
  COSTO UNIT ARS = 100

Sistema calcula:
  COSTO TOTAL ARS = COSTO UNIT ARS Ã— CANTIDAD
                  = 100 Ã— 10
                  = 1.000
```

### OpciÃ³n B: Solo COSTO TOTAL ARS
```
Usuario ingresa:
  COSTO TOTAL ARS = 1.000

Sistema calcula:
  COSTO UNIT ARS = COSTO TOTAL ARS / CANTIDAD
                 = 1.000 / 10
                 = 100
```

### OpciÃ³n C: Ambos (conflicto)
```
Usuario ingresa:
  COSTO UNIT ARS = 100
  COSTO TOTAL ARS = 1.500  â† NO COINCIDE (100 Ã— 10 = 1.000, no 1.500)

Sistema usa PRIORIDAD a TOTAL:
  COSTO UNIT ARS = 1.500 / 10 = 150  â† CORREGIDO
  COSTO TOTAL ARS = 1.500  â† MANTIENE
```

---

## ğŸ“‹ Campos Eliminados (o Deprecados)

| Campo Viejo | RazÃ³n | QuÃ© hacer |
|-------------|-------|-----------|
| `dif unit` | Poco claro, no se usa | Calcular on-the-fly si se necesita |
| `P.UNIT MINIMO` | Sustituido por `PRECIO UNIT ACEPTABLE` | Usar el nuevo nombre |
| `SUBTOTAL` | Ambiguo y no se usa | Usar `COSTO TOTAL ARS` |
| `Renta DPC` | Sustituido por `RENTA PARA MEJORAR %` | Usar el nuevo nombre |

---

## ğŸ’¾ Base de Datos: Cambios

### Renombres en tabla `renglon_excel`:
```sql
obs               â†’ obs_usuario
costo_final       â†’ costo_unit_ars
subtotal_costo    â†’ costo_total_ars
renta_ref         â†’ renta_referencia
p_unit_mejora     â†’ precio_unit_mejora
renta_dpc         â†’ renta_para_mejorar  (deprecar)
```

### Nuevas columnas:
```sql
costo_unit_usd         (REAL)
costo_total_usd        (REAL)
renta_minima           (REAL)
precio_unit_aceptable  (REAL)
precio_total_aceptable (REAL)
precio_ref_unitario    (REAL)
```

---

## ğŸ“ Archivos a Editar (EN ORDEN)

1. **`app/ui/table_manager.py`**
   - Actualizar `columns` tuple
   - Actualizar `column_labels` dict
   - Actualizar `column_widths` dict

2. **`app/ui/formatters.py`**
   - Actualizar `DisplayValues.build_row_values()` con nuevos fields en nuevo orden

3. **`app/excel/excel_io.py`**
   - Actualizar `COLUMNS` lista
   - Actualizar `USER_FIELDS`, `CALC_FIELDS`, `MONEY_COLS`, `PERCENT_COLS` sets
   - Actualizar `FORMULAS` dict
   - Actualizar `required` set en `import_excel_to_rows()`

4. **`app/core/app_runtime.py`**
   - Actualizar `import_excel()` â†’ cambiar `row.get("...")` calls
   - Actualizar `update_renglon_excel()` signature

5. **`app/core/engine.py`**
   - Agregar mÃ©todo `_resolve_costo_final()` (bidireccionalidad)
   - Actualizar `_process_renglon()` para usar nuevos fields
   - Actualizar cÃ¡lculos de rentas/precios

6. **`app/models/domain.py`**
   - Actualizar `UIRow` dataclass con nuevos fields

7. **`scripts/migrate_columns_v2.py` (NUEVO)**
   - Script para migrar BD (reversible)

---

## â±ï¸ Timeframe

| Tarea | Tiempo |
|-------|--------|
| Actualizar 5 archivos Python | 2-3 horas |
| Implementar bidireccionalidad | 1-2 horas |
| Migrar BD | 30 min |
| Testing exhaustivo | 2-4 horas |
| **TOTAL** | **5.5 - 9.5 horas** |

---

## âœ… Validaciones Finales

Antes de commit, verificar:

- [ ] Tabla en UI muestra columnas nuevas en correcto orden
- [ ] Labels son claros y legibles
- [ ] DiÃ¡logo de "Configurar Columnas" muestra etiquetas nuevas
- [ ] Exportar Excel genera encabezados correctos
- [ ] Importar Excel detecta encabezados nuevos
- [ ] FÃ³rmulas en Excel se recalculan correctamente
- [ ] Bidireccionalidad COSTO funciona (ambos sentidos)
- [ ] No hay errores en consola
- [ ] Datos viejos se migran sin pÃ©rdida

